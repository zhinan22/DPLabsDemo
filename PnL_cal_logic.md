### PnL（盈亏）计算逻辑说明

#### 一、核心目标

基于用户的交易记录（买入 / 卖出某代币的订单），计算该代币的持仓盈亏情况，包括平均成本、已实现盈亏、未实现盈亏及盈亏百分比，支持多次买卖、部分平仓及完全平仓的场景。

#### 二、核心概念与数据跟踪

通过 “持仓（Position）” 跟踪代币的持有状态，核心记录以下关键信息：

- **当前持仓数量**：当前实际持有的代币数量（卖出后减少，平仓后为 0）。
- **当前持仓成本**：当前持有部分对应的成本（美元计价，随买入增加、卖出减少）。
- **已实现盈亏**：通过卖出操作实际获得的盈亏总和（盈利为正，亏损为负）。
- **总投入成本**：历史累计买入该代币的总花费（美元，不随卖出减少，平仓后仍保留）。
- **总买入数量**：历史累计买入该代币的总数量（不随卖出减少，平仓后仍保留）。
- **平均成本**：基于总投入成本和总买入数量计算的加权平均价（总投入成本 ÷ 总买入数量，平仓后仍保留）。
- **持仓状态**：标记是否已平仓（当前持仓数量为 0 时为 “已平仓”）。

#### 三、交易处理流程

遍历用户的每一笔交易，区分 “买入” 和 “卖出” 操作，更新持仓信息：

##### 1. 交易识别与数据解析

- **判断交易类型**：若交易中买入的是目标代币（`BuyToken.Mint`等于目标代币地址），则为 “买入操作”；若卖出的是目标代币（`SellToken.Mint`等于目标代币地址），则为 “卖出操作”。
- **解析交易数量**：根据交易记录中的原始数量（`Amount`）和代币小数位数（`Decimals`），计算实际数量（公式：`实际数量 = Amount ÷ 10^Decimals`，例如：Amount=1000、Decimals=3 时，实际数量 = 1.000）。
- **计算美元价值**：根据交易时的市场价格，计算该笔交易的美元价值（买入时为成本，卖出时为收入）。

##### 2. 买入操作处理

当买入目标代币时，更新持仓信息：

- **累计总投入与总数量**：总投入成本 += 本次买入的美元价值；总买入数量 += 本次买入的实际数量。
- **更新平均成本**：平均成本 = 总投入成本 ÷ 总买入数量（每次买入后重新计算，反映加权平均价）。
- **更新当前持仓**：当前持仓数量 += 本次买入的实际数量；当前持仓成本 += 本次买入的美元价值。
- **记录交易**：将该笔买入交易添加到持仓的交易记录中。

##### 3. 卖出操作处理

当卖出目标代币时，计算盈亏并更新持仓：

- **计算单次实现盈亏**：本次卖出的实现盈亏 = 本次卖出的美元收入 -（本次卖出数量 × 平均成本）（盈利为正，亏损为负）。
- **累计已实现盈亏**：总已实现盈亏 += 本次实现盈亏。
- **更新当前持仓**：当前持仓数量 -= 本次卖出的实际数量；当前持仓成本 -=（本次卖出数量 × 平均成本）。
- **判断平仓**：若当前持仓数量 ≤ 0，标记该持仓为 “已平仓”，不再跟踪当前持仓（但保留总投入、总数量、平均成本等历史数据）。
- **记录交易**：将该笔卖出交易添加到持仓的交易记录中。

##### 4. 持仓汇总

遍历所有交易后，汇总所有持仓（包括已平仓和未平仓的）：

- 若存在未平仓的持仓（当前持仓数量 > 0），将其纳入汇总结果。
- 已平仓的持仓直接纳入汇总结果。

#### 四、盈亏结果计算

针对每一个持仓，计算最终的盈亏指标：

##### 1. 平均成本

- 取值：使用持仓记录的 “平均成本”（总投入成本 ÷ 总买入数量）。
- 格式：保留最多 9 位小数（截断处理，不四舍五入）。
- 特殊情况：即使持仓已平仓，仍保留该值（反映历史平均买入价）。

##### 2. 已实现盈亏值

- 取值：持仓记录的 “总已实现盈亏”（所有卖出操作的盈亏总和）。
- 格式：保留 2 位小数（截断处理，不四舍五入）。

##### 3. 已实现盈亏百分比

- 计算公式：（已实现盈亏 ÷ 总投入成本）× 100%。
- 格式：保留 2 位小数，带 “%” 符号（例如：盈利 15% 显示为 “15.00%”，亏损 5% 显示为 “-5.00%”）。
- 特殊情况：若总投入成本为 0（理论上不可能，因买入才会产生持仓），则百分比为 0。

##### 4. 未实现盈亏值

- 取值：仅针对未平仓持仓，计算公式为：（当前持仓数量 × 当前市场价格）- 当前持仓成本（反映按当前价格卖出可获得的潜在盈亏）。
- 格式：保留 2 位小数（截断处理，不四舍五入）。
- 特殊情况：已平仓的持仓，未实现盈亏为 0。

##### 5. 持仓状态

- 标记该持仓是否已平仓（`IsClosed`为`true`表示已平仓，`false`表示未平仓）。